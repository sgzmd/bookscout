<div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm"
     role="dialog"
     aria-modal="true"
     @click.self="window.location.href='/dashboard'"> <!-- Simple close on backdrop click (navigation) -->

    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
        <form action="<%= isEdit ? `/books/${book.id}/edit` : '/books' %>" method="POST" class="flex flex-col md:flex-row">
            <!-- Hidden Fields -->
            <% if (!isEdit) { %>
            <input type="hidden" name="google_books_id" value="<%= book.google_id %>">
            <input type="hidden" name="title" value="<%= book.title %>">
            <input type="hidden" name="author" value="<%= book.author %>">
            <input type="hidden" name="cover_url" value="<%= book.cover_url %>">
            <% } %>

            <!-- Cover Section -->
            <div class="bg-emerald-50 p-8 flex flex-col items-center justify-center md:w-1/3">
                <img src="<%= book.cover_url %>" alt="<%= book.title %>" class="w-32 shadow-lg rounded mb-4 transform -rotate-3 hover:rotate-0 transition-transform duration-300">
                <h3 class="text-center font-bold text-emerald-900 leading-tight"><%= book.title %></h3>
                <p class="text-center text-sm text-emerald-600 mt-1"><%= book.author %></p>
                <% if (isEdit) { %>
                    <button type="button" 
                            hx-post="/books/<%= book.id %>/delete" 
                            hx-confirm="Are you sure you want to delete this book?"
                            class="mt-6 text-red-500 hover:text-red-700 text-sm font-bold flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        Delete Book
                    </button>
                <% } %>
            </div>

            <!-- Form Section -->
            <div class="p-8 md:w-2/3 space-y-6">
                <h2 class="text-2xl font-bold text-slate-800"><%= isEdit ? 'Update your review' : 'How was it?' %></h2>

                <!-- Stars -->
                <div>
                    <label class="block text-sm font-medium text-slate-500 mb-2">Rating</label>
                    <div x-data="{ rating: <%= book.rating || 0 %>, hover: 0 }" class="flex space-x-1">
                      <input type="hidden" name="rating" :value="rating" required>
                      
                      <template x-for="star in 5">
                        <button 
                          type="button"
                          @click="rating = star" 
                          @mouseover="hover = star" 
                          @mouseleave="hover = 0"
                          class="focus:outline-none transition-transform duration-100 hover:scale-110"
                        >
                          <svg class="w-10 h-10" :class="(hover >= star || rating >= star) ? 'text-yellow-400 fill-current' : 'text-gray-200 fill-current'" viewBox="0 0 24 24">
                            <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                          </svg>
                        </button>
                      </template>
                    </div>
                </div>

                <!-- Tags -->
                <div>
                    <label class="block text-sm font-medium text-slate-500 mb-2">Tags</label>
                    <div x-data="{ selectedTags: '<%= book.tags || '' %>'.split(',').filter(Boolean) }" class="space-y-4">
                      <input type="hidden" name="tags" :value="selectedTags.join(',')">
                      
                      <div class="flex flex-wrap gap-2">
                        <% ['Funny', 'Adventure', 'Fantasy', 'Scary', 'Sad', 'Educational'].forEach(tag => { %>
                          <button 
                            type="button"
                            @click="selectedTags.includes('<%= tag %>') ? selectedTags = selectedTags.filter(t => t !== '<%= tag %>') : selectedTags.push('<%= tag %>')"
                            :class="selectedTags.includes('<%= tag %>') ? 'bg-emerald-100 text-emerald-700 border-emerald-300' : 'bg-gray-50 text-slate-600 border-gray-200'"
                            class="px-4 py-2 rounded-full border text-sm font-medium transition-colors"
                          >
                            <%= tag %>
                          </button>
                        <% }) %>
                      </div>
                    </div>
                </div>

                <!-- Notes -->
                <div>
                    <label class="block text-sm font-medium text-slate-500 mb-2">My Thoughts</label>
                    <textarea name="notes" rows="3" class="w-full p-3 rounded-xl border border-gray-200 focus:border-emerald-400 focus:ring-0 text-slate-700 resize-none" placeholder="What was your favorite part?"><%= book.notes || '' %></textarea>
                </div>

                <!-- Actions -->
                <div class="flex justify-end space-x-3 pt-4">
                    <a href="/dashboard" class="px-6 py-3 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition-colors">Cancel</a>
                    <button type="submit" class="px-8 py-3 bg-emerald-400 hover:bg-emerald-500 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5">
                        <%= isEdit ? 'Update Review' : 'Save to Library' %>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
